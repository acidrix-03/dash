{% extends "base.html" %}

{% block content %}

<div class="container mt-5">
    <h2 class="text-center mb-4">Recommended Applications</h2>

    <!-- Global Search Bar -->
    <div class="mb-4">
        <input type="text" id="globalSearch" class="form-control" onkeyup="filterAllTables()" placeholder="Search for applications...">
    </div>

    <!-- CTO Applications Section -->
    <div class="application-section mb-4">
        <h3>CTO Applications</h3>
        <table id="ctoTable" class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th onclick="sortTable('ctoTable', 0)" class="sortable">ID</th>
                    <th onclick="sortTable('ctoTable', 1)" class="sortable">Name</th>
                    <th onclick="sortTable('ctoTable', 2)" class="sortable">Position</th>
                    <th onclick="sortTable('ctoTable', 3)" class="sortable">Days</th>
                    <th onclick="sortTable('ctoTable', 4)" class="sortable">Start Date</th>
                    <th onclick="sortTable('ctoTable', 5)" class="sortable">End Date</th>
                    <th onclick="sortTable('ctoTable', 6)" class="sortable">Date Recommended</th>
                </tr>
            </thead>
            <tbody>
                {% for app in cto_recommended_apps %}
                <tr>
                    <td>{{ app[0] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[4] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[6] }}</td>
                    <td>{{ app[7] }}</td>
                    <td>{{ app[11] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="ctoPagination" class="pagination-controls"></div>
    </div>

    <!-- Leave Applications Section -->
    <div class="application-section mb-4">
        <h3>Leave Applications</h3>
        <table id="leaveTable" class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th onclick="sortTable('leaveTable', 0)" class="sortable">ID</th>
                    <th onclick="sortTable('leaveTable', 1)" class="sortable">Name</th>
                    <th onclick="sortTable('leaveTable', 2)" class="sortable">Position</th>
                    <th onclick="sortTable('leaveTable', 3)" class="sortable">Days</th>
                    <th onclick="sortTable('leaveTable', 4)" class="sortable">Start Date</th>
                    <th onclick="sortTable('leaveTable', 5)" class="sortable">End Date</th>
                    <th onclick="sortTable('leaveTable', 6)" class="sortable">Date Recommended</th>
                </tr>
            </thead>
            <tbody>
                {% for app in leave_recommended_apps %}
                <tr>
                    <td>{{ app[0] }}</td>
                    <td>{{ app[1] }}</td>
                    <td>{{ app[2] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[4] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[7] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="leavePagination" class="pagination-controls"></div>
    </div>

    <!-- Travel Authorities Section -->
    <div class="application-section mb-4">
        <h3>Travel Authorities</h3>
        <table id="travelTable" class="table table-striped table-bordered">
            <thead class="thead-dark">
                <tr>
                    <th onclick="sortTable('travelTable', 0)" class="sortable">ID</th>
                    <th onclick="sortTable('travelTable', 1)" class="sortable">Name</th>
                    <th onclick="sortTable('travelTable', 2)" class="sortable">Position</th>
                    <th onclick="sortTable('travelTable', 3)" class="sortable">Start Date</th>
                    <th onclick="sortTable('travelTable', 4)" class="sortable">End Date</th>
                    <th onclick="sortTable('travelTable', 5)" class="sortable">Destination</th>
                    <th onclick="sortTable('travelTable', 6)" class="sortable">Purpose</th>
                    <th onclick="sortTable('travelTable', 7)" class="sortable">Date Recommended</th>
                </tr>
            </thead>
            <tbody>
                {% for app in travel_recommended_apps %}
                <tr>
                    <td>{{ app[1] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[4] }}</td>
                    <td>{{ app[7] }}</td>
                    <td>{{ app[8] }}</td>
                    <td>{{ app[9] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[11] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="travelPagination" class="pagination-controls"></div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('recommender_dashboard') }}" class="btn btn-secondary mb-3">Go back to Dashboard</a>
    </div>
</div>

<script>
// Filtering function for global search
function filterAllTables() {
    let input = document.getElementById('globalSearch');
    let filter = input.value.toUpperCase();
    let tables = ['ctoTable', 'leaveTable', 'travelTable'];
    
    tables.forEach(tableId => {
        let table = document.getElementById(tableId);
        let tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            let tdArray = tr[i].getElementsByTagName('td');
            let rowContainsSearchText = Array.from(tdArray).some(td => {
                return td.textContent.toUpperCase().indexOf(filter) > -1;
            });
            tr[i].style.display = rowContainsSearchText ? '' : 'none';
        }
    });
}

// Function to sort table by a given column index
function sortTable(tableId, colIndex) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let sortedRows = Array.from(rows).sort((a, b) => {
        let aVal = a.getElementsByTagName('td')[colIndex].innerText;
        let bVal = b.getElementsByTagName('td')[colIndex].innerText;

        // Sort by date if the column is a date
        if (colIndex >= 4) { // Assuming start/end/date columns are at index 4 or higher
            return new Date(bVal) - new Date(aVal);  // Descending sort
        }

        return aVal.localeCompare(bVal); // Default string sort
    });

    // Clear and re-append rows in sorted order
    let tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
}

// Function to paginate the table
function paginateTable(tableId, itemsPerPage) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let totalPages = Math.ceil(rows.length / itemsPerPage);

    // Create pagination controls
    let pagination = document.getElementById(tableId + 'Pagination');
    pagination.innerHTML = ''; // Clear previous pagination

    for (let i = 1; i <= totalPages; i++) {
        let button = document.createElement('button');
        button.innerText = i;
        button.classList.add('btn', 'btn-outline-primary', 'mx-1');
        button.onclick = function () {
            displayPage(tableId, i, itemsPerPage);
        };
        pagination.appendChild(button);
    }
}

// Function to display specific page
function displayPage(tableId, pageNum, itemsPerPage) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = (Math.floor(i / itemsPerPage) === pageNum - 1) ? '' : 'none';
    }
}

// Initialize tables on document ready
$(document).ready(function() {
    const itemsPerPage = 5; // Set number of items per page
    paginateTable('ctoTable', itemsPerPage);
    paginateTable('leaveTable', itemsPerPage);
    paginateTable('travelTable', itemsPerPage);
});
</script>

<style>
body {
    background-color: #f8f9fa;
}
.application-section {
    background-color: #fff;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
.sortable {
    cursor: pointer;
}
.pagination-controls {
    margin-top: 20px;
}
</style>

{% endblock %}

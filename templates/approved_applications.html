{% extends "base.html" %}
{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Approved Applications</h2>

    <!-- Global Search Bar -->
    <div class="mb-4">
        <input type="text" id="globalSearch" onkeyup="filterAllTables()" class="form-control" placeholder="Search for applications...">
    </div>

    <!-- CTO Applications -->
    <div class="application-section">
        <h3 class="section-title">CTO Applications</h3>
        <table class="table table-striped table-bordered" id="ctoTable">
            <thead class="thead-dark">
                <tr>
                    <th class="sortable">ID</th>
                    <th class="sortable">Name</th>
                    <th class="sortable">Position</th>
                    <th class="sortable">Days</th>
                    <th class="sortable">Start Date</th>
                    <th class="sortable">End Date</th>
                    <th class="sortable" data-sort="date">Date Approved</th>
                </tr>
            </thead>
            <tbody>
                {% for app in cto_approved_apps %}
                <tr>
                    <td>{{ app[0] }}</td>
                    <td>{{ app[2] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[4] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[6] }}</td>
                    <td data-date="{{ app[9] }}">{{ app[9] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="ctoPagination" class="pagination-controls"></div>
    </div>

    <!-- Leave Applications -->
    <div class="application-section mt-4">
        <h3 class="section-title">Leave Applications</h3>
        <table class="table table-striped table-bordered" id="leaveTable">
            <thead class="thead-dark">
                <tr>
                    <th class="sortable">ID</th>
                    <th class="sortable">Name</th>
                    <th class="sortable">Position</th>
                    <th class="sortable">Days</th>
                    <th class="sortable">Start Date</th>
                    <th class="sortable">End Date</th>
                    <th class="sortable" data-sort="date">Date Approved</th>
                </tr>
            </thead>
            <tbody>
                {% for app in leave_approved_apps %}
                <tr>
                    <td>{{ app[0] }}</td>
                    <td>{{ app[2] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[4] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[6] }}</td>
                    <td data-date="{{ app[9] }}">{{ app[9] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="leavePagination" class="pagination-controls"></div>
    </div>

    <!-- Travel Authorities -->
    <div class="application-section mt-4">
        <h3 class="section-title">Travel Authorities</h3>
        <table class="table table-striped table-bordered" id="travelTable">
            <thead class="thead-dark">
                <tr>
                    <th class="sortable">ID</th>
                    <th class="sortable">Name</th>
                    <th class="sortable">Position</th>
                    <th class="sortable">Start Date</th>
                    <th class="sortable">End Date</th>
                    <th class="sortable">Destination</th>
                    <th class="sortable">Purpose</th>
                    <th class="sortable" data-sort="date">Date Approved</th>
                </tr>
            </thead>
            <tbody>
                {% for app in travel_approved_apps %}
                <tr>
                    <td>{{ app[0] }}</td>
                    <td>{{ app[2] }}</td>
                    <td>{{ app[3] }}</td>
                    <td>{{ app[5] }}</td>
                    <td>{{ app[6] }}</td>
                    <td>{{ app[7] }}</td>
                    <td>{{ app[8] }}</td>
                    <td data-date="{{ app[9] }}">{{ app[9] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div id="travelPagination" class="pagination-controls"></div>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('approver_dashboard') }}" class="btn btn-primary">Go back to dashboard</a>
    </div>
</div>

<!-- Pagination and Sorting/Filtering JavaScript -->
<script>
function filterAllTables() {
    let input = document.getElementById('globalSearch');
    let filter = input.value.toUpperCase();
    let tables = ['ctoTable', 'leaveTable', 'travelTable'];
    
    tables.forEach(tableId => {
        let table = document.getElementById(tableId);
        let tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            let tdArray = tr[i].getElementsByTagName('td');
            let rowContainsSearchText = Array.from(tdArray).some(td => {
                return td.textContent.toUpperCase().indexOf(filter) > -1;
            });
            tr[i].style.display = rowContainsSearchText ? '' : 'none';
        }
    });
}

function sortTable(tableId, colIndex) {
    let table = document.getElementById(tableId);
    let rows = Array.from(table.getElementsByTagName('tbody')[0].getElementsByTagName('tr'));
    let isNumeric = !isNaN(rows[0].getElementsByTagName('td')[colIndex].innerText);
    let isDate = rows[0].getElementsByTagName('td')[colIndex].getAttribute('data-date') !== null;
    
    rows.sort((a, b) => {
        let aVal = a.getElementsByTagName('td')[colIndex].getAttribute('data-date') || a.getElementsByTagName('td')[colIndex].innerText;
        let bVal = b.getElementsByTagName('td')[colIndex].getAttribute('data-date') || b.getElementsByTagName('td')[colIndex].innerText;

        if (isDate) {
            return new Date(aVal) - new Date(bVal);
        } else if (isNumeric) {
            return parseFloat(aVal) - parseFloat(bVal);
        } else {
            return aVal.localeCompare(bVal);
        }
    });

    if (table.getAttribute("data-sort-order") === "desc") {
        rows.reverse();
        table.setAttribute("data-sort-order", "asc");
    } else {
        table.setAttribute("data-sort-order", "desc");
    }

    let tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function paginateTable(tableId, itemsPerPage) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let paginationControls = document.getElementById(tableId + 'Pagination');
    let totalPages = Math.ceil(rows.length / itemsPerPage);
    let currentPage = 1;

    function showPage(page) {
        let start = (page - 1) * itemsPerPage;
        let end = start + itemsPerPage;
        
        for (let i = 0; i < rows.length; i++) {
            rows[i].style.display = (i >= start && i < end) ? '' : 'none';
        }
    }

    function createPagination() {
        paginationControls.innerHTML = '';
        for (let i = 1; i <= totalPages; i++) {
            let btn = document.createElement('button');
            btn.innerText = i;
            btn.classList.add('btn', 'btn-secondary');
            if (i === currentPage) btn.classList.add('active');
            btn.addEventListener('click', function() {
                currentPage = i;
                showPage(currentPage);
                createPagination();
            });
            paginationControls.appendChild(btn);
        }
    }

    showPage(currentPage);
    createPagination();
}

window.onload = function() {
    const tables = ['ctoTable', 'leaveTable', 'travelTable'];
    tables.forEach(tableId => {
        let headers = document.getElementById(tableId).getElementsByTagName('th');
        for (let i = 0; i < headers.length; i++) {
            headers[i].onclick = () => sortTable(tableId, i);
        }
    });

    sortTable('ctoTable', 6);
    sortTable('leaveTable', 6);
    sortTable('travelTable', 7);
    
    paginateTable('ctoTable', 5);
    paginateTable('leaveTable', 5);
    paginateTable('travelTable', 5);
}
</script>

<style>
    .application-section {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
    }

    thead th {
        background-color: #000; /* Set header background to black */
        color: #fff;            /* Set header text color to white */
        border: 1px solid #fff; /* Optional: Add a white border for better visibility */
    }

    .sortable:hover {
        cursor: pointer;
        text-decoration: underline;
    }

    .pagination-controls button {
        margin: 0 2px;
    }

    .pagination-controls {
        margin-top: 15px;
        text-align: center;
    }

    .thead-dark th {
        background-color: #000; /* Ensure this is also set to black */
        color: #fff;
    }

    .btn.active {
        background-color: #007bff;
        color: white;
    }
</style>


{% endblock %}

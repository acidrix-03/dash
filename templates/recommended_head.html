{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Recommended Applications for Unit Head</h2>

    <!-- Global Search Bar -->
    <div class="mb-4">
        <input type="text" id="globalSearch" class="form-control" onkeyup="filterAllTables()" placeholder="Search for applications...">
    </div>

    <!-- CTO Applications -->
    <h3>CTO Applications</h3>
    <table id="ctoTable" class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th onclick="sortTable('ctoTable', 0)" class="sortable">ID</th>
                <th onclick="sortTable('ctoTable', 1)" class="sortable">Name</th>
                <th onclick="sortTable('ctoTable', 2)" class="sortable">Position</th>
                <th onclick="sortTable('ctoTable', 3)" class="sortable">Days</th>
                <th onclick="sortTable('ctoTable', 4)" class="sortable">Start Date</th>
                <th onclick="sortTable('ctoTable', 5)" class="sortable">End Date</th>
                <th onclick="sortTable('ctoTable', 6)" class="sortable">Date Recommended</th>
            </tr>
        </thead>
        <tbody>
            {% for app in cto_recommended_apps %}
            <tr>
                <td>{{ app[0] }}</td>
                <td>{{ app[1] }}</td>
                <td>{{ app[2] }}</td>
                <td>{{ app[3] }}</td>
                <td>{{ app[4] }}</td>
                <td>{{ app[5] }}</td>
                <td>{{ app[6] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="ctoPagination" class="pagination-controls"></div>

    <!-- Leave Applications -->
    <h3>Leave Applications</h3>
    <table id="leaveTable" class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th onclick="sortTable('leaveTable', 0)" class="sortable">ID</th>
                <th onclick="sortTable('leaveTable', 1)" class="sortable">Name</th>
                <th onclick="sortTable('leaveTable', 2)" class="sortable">Position</th>
                <th onclick="sortTable('leaveTable', 3)" class="sortable">Days</th>
                <th onclick="sortTable('leaveTable', 4)" class="sortable">Start Date</th>
                <th onclick="sortTable('leaveTable', 5)" class="sortable">End Date</th>
                <th onclick="sortTable('leaveTable', 6)" class="sortable">Leave Type</th>
                <th onclick="sortTable('leaveTable', 7)" class="sortable">Date Recommended</th>
            </tr>
        </thead>
        <tbody>
            {% for app in leave_recommended_apps %}
            <tr>
                <td>{{ app[0] }}</td>
                <td>{{ app[1] }}</td>
                <td>{{ app[2] }}</td>
                <td>{{ app[3] }}</td>
                <td>{{ app[4] }}</td>
                <td>{{ app[5] }}</td>
                <td>{{ app[6] }}</td>
                <td>{{ app[7] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="leavePagination" class="pagination-controls"></div>

    <!-- Travel Authority Applications -->
    <h3>Travel Authority Applications</h3>
    <table id="travelTable" class="table table-striped table-bordered">
        <thead class="thead-dark">
            <tr>
                <th onclick="sortTable('travelTable', 0)" class="sortable">ID</th>
                <th onclick="sortTable('travelTable', 1)" class="sortable">Name</th>
                <th onclick="sortTable('travelTable', 2)" class="sortable">Position</th>
                <th onclick="sortTable('travelTable', 3)" class="sortable">Destination</th>
                <th onclick="sortTable('travelTable', 4)" class="sortable">Host</th>
                <th onclick="sortTable('travelTable', 5)" class="sortable">Start Date</th>
                <th onclick="sortTable('travelTable', 6)" class="sortable">End Date</th>
                <th onclick="sortTable('travelTable', 7)" class="sortable">Date Recommended</th>
            </tr>
        </thead>
        <tbody>
            {% for app in travel_recommended_apps %}
            <tr>
                <td>{{ app[0] }}</td>
                <td>{{ app[1] }}</td>                
                <td>{{ app[2] }}</td>
                <td>{{ app[3] }}</td>
                <td>{{ app[4] }}</td>
                <td>{{ app[5] }}</td>
                <td>{{ app[6] }}</td>
                <td>{{ app[7] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div id="travelPagination" class="pagination-controls"></div>

    <a href="{{ url_for('unit_head_dashboard') }}" class="btn btn-secondary mt-3">Back to Dashboard</a>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
// Filtering function for global search
function filterAllTables() {
    let input = document.getElementById('globalSearch');
    let filter = input.value.toUpperCase();
    let tables = ['ctoTable', 'leaveTable', 'travelTable'];
    
    tables.forEach(tableId => {
        let table = document.getElementById(tableId);
        let tr = table.getElementsByTagName('tr');
        for (let i = 1; i < tr.length; i++) {
            let tdArray = tr[i].getElementsByTagName('td');
            let rowContainsSearchText = Array.from(tdArray).some(td => {
                return td.textContent.toUpperCase().indexOf(filter) > -1;
            });
            tr[i].style.display = rowContainsSearchText ? '' : 'none';
        }
    });
}

// Function to sort table by a given column index
function sortTable(tableId, colIndex) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let sortedRows = Array.from(rows).sort((a, b) => {
        let aVal = a.getElementsByTagName('td')[colIndex].innerText;
        let bVal = b.getElementsByTagName('td')[colIndex].innerText;

        // Sort by date if the column is a date
        if (colIndex >= 4) { // Assuming start/end/date columns are at index 4 or higher
            return new Date(bVal) - new Date(aVal);  // Descending sort
        }

        return aVal.localeCompare(bVal); // Default string sort
    });

    // Clear and re-append rows in sorted order
    let tbody = table.getElementsByTagName('tbody')[0];
    tbody.innerHTML = '';
    sortedRows.forEach(row => tbody.appendChild(row));
}

// Function to paginate the table
function paginateTable(tableId, itemsPerPage) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    let totalPages = Math.ceil(rows.length / itemsPerPage);

    // Create pagination controls
    let pagination = document.getElementById(tableId + 'Pagination');
    pagination.innerHTML = ''; // Clear previous pagination

    for (let i = 1; i <= totalPages; i++) {
        let button = document.createElement('button');
        button.innerText = i;
        button.classList.add('btn', 'btn-outline-primary', 'mx-1');
        button.onclick = function () {
            displayPage(tableId, i, itemsPerPage);
        };
        pagination.appendChild(button);
    }
}

// Function to display specific page
function displayPage(tableId, pageNum, itemsPerPage) {
    let table = document.getElementById(tableId);
    let rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        rows[i].style.display = (Math.floor(i / itemsPerPage) === pageNum - 1) ? '' : 'none';
    }
}

// Initialize tables on document ready
$(document).ready(function() {
    const itemsPerPage = 5; // Set number of items per page
    paginateTable('ctoTable', itemsPerPage);
    paginateTable('leaveTable', itemsPerPage);
    paginateTable('travelTable', itemsPerPage);

    // AJAX for recommending applications
    $('.recommend-btn').on('click', function() {
        var button = $(this);
        var appId = button.data('id');  // Get application ID
        var applicationType = button.data('type');  // Get application type

        $.ajax({
            type: 'POST',
            url: '/recommend_approval/' + appId,
            data: { application_type: applicationType },
            success: function(response) {
                if (response.success) {
                    button.text('Recommended').attr('disabled', true).removeClass('btn-primary').addClass('btn-secondary');
                    alert('Application successfully recommended!');
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function() {
                alert('An error occurred. Please try again.');
            }
        });
    });
});
</script>

<style>
body {
    background-color: #f8f9fa;
}
.table th {
    background-color: #ff0000; /* Change header color to black */
    color: white;
}
.table tbody tr:hover {
    background-color: #e9ecef;
}
.sortable:hover {
    cursor: pointer;
    text-decoration: underline;
}
.pagination-controls {
    margin-top: 15px;
    text-align: center;
}
</style>

{% endblock %}
